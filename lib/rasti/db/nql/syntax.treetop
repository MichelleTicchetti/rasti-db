module Rasti
  module DB
    module NQL
      grammar Syntax
        
        rule sentence
          optional_space proposition:proposition optional_space <Sentence>
        end

        rule proposition
          statement   /
          disjunction /
          conjunction
        end

        rule disjunction
          left:(statement / conjunction) mandatory_space '|' mandatory_space right:proposition <Disjunction>
        end

        rule conjunction
          left:statement mandatory_space '&' mandatory_space right:(statement / conjunction) <Conjunction>
        end

        rule statement
          comparison /
          parenthesis_sentence
        end

        rule parenthesis_sentence
          '(' sentence ')' <ParenthesisSentence>
        end

        rule comparison
          left:field optional_space comparator:comparator optional_space right:basic <Comparison>
        end

        rule field
          _tables:(table:field_name '.')* _name:field_name <Field>
        end

        rule comparator
          ':'  /
          '!:' /
          '~'  /
          '>=' /
          '<=' /
          '>'  /
          '<'  /
          '!=' /
          '='
        end

        rule basic
          boolean        /
          time           /
          float          /
          integer        /
          literal_string /
          string
        end

        rule optional_space
          [\s\t\n]*
        end

        rule mandatory_space
          [\s\t\n]+
        end

        rule field_name
          [a-z_]+
        end

        rule time
          date:(value:date 'T')? hour:(digit digit) ':' minutes:(digit digit) seconds:(':' value:(digit digit))? timezone:(value:timezone)? <TimeConstant>
        end

        rule date
          year:(digit digit digit digit) '-' month:(digit digit) '-' day:(digit digit) <Date>
        end

        rule timezone
          sign:sign hour:(digit digit) ':' minutes:(digit digit) <TimeZone>
        end

        rule sign
          '+' / 
          '-'
        end

        rule literal_string
          '"' string:any_character+ '"' <LiteralStringConstant>
        end

        rule string
          valid_character+ <StringConstant>
        end

        rule any_character
          valid_character /
          reserved_character
        end

        rule valid_character 
          [0-9a-zA-ZÁÀÄÂÃÅĀĂǍáàäâãåāăǎÉÈËÊĒĔĖĚéèëêēĕėěÍÌÏÎĨĬǏíìïîĩĭǐÓÒÖÔÕŌŎŐǑóòöôõōŏőǒÚÙÜÛŨŪŬŮŰǓúùüûũūŭůűǔÑñçÇ%@#+-_'?!$*/\s]
        end

        rule boolean
          true /
          false
        end

        rule true
          'true' <TrueConstant>
        end

        rule false
          'false' <FalseConstant>
        end

        rule float
          digit+ '.' digit+ <FloatConstant>
        end

        rule integer
          digit+ <IntegerConstant>
        end

        rule digit
          [0-9]
        end

        rule reserved_character
          [&|.():!=<>~]
        end

      end
    end
  end
end